<!DOCTYPE html><!--[if IE 8]><html class="no-js lt-ie9" lang="en"><![endif]--><!--[if gt IE 8 ]><!--><html class="no-js" lang="en"><!--<![endif]--><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="IE=edge"><link rel="stylesheet" href="/stylesheets/styles.css"><script src="/javascripts/jquery.js"></script><script src="/javascripts/bootstrap.min.js"></script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-113442079-2"></script><title>Beer Garden Documentation</title></head><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());

gtag('config', 'UA-113442079-2');</script><body class="antialiased"><div class="bootstrap"><nav class="navbar navbar-default navbar-fixed-top" role="navigation"><div class="container"><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#navbar-collapse-1" aria-expanded="false"><span class="sr-only">Toggle Navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/"><img src="/images/bg-banner.png">Beer Garden</img></a></div><div class="collapse navbar-collapse" id="navbar-collapse-1"><ul class="nav navbar-nav navbar-right"><li><a href="/">Home</a></li><li class="divider"></li><li><a href="https://github.com/beer-garden/beer-garden">Code</a></li><li class="divider"></li><li><a href="/docs/">Docs</a></li></ul></div></div></nav><main><div class="bootstrap masthead"><div class="container"><h2 class="hero">Mongo Pruner</h2></div></div><div class="bootstrap container"><div class="row top-buffer"><div class="col-lg-4"><div class="col-lg-12"><div class="btn-toolbar" role="toolbar" aria-label="Toolbar with button groups"><div class="btn-group mr-2" role="group" aria-label="First group"><button class="btn btn-default toggle-navigation" type="button" href="#"><span class="toggle-target"><i class="fa fa-toggle-on"></i><i class="fa fa-toggle-off"></i> Nav</span></button></div><div class="btn-group-mr-2 pull-right" role="group" aria-label="First Group"><a class="btn btn-default" href="https://github.com/beer-garden/beer-garden.io/edit/master//docs/app/mongo_pruner.adoc">Edit</a><a class="btn btn-default" href="https://github.com/beer-garden/beer-garden.io/raw/master//docs/app/mongo_pruner.adoc">Raw</a><a class="btn btn-default" href="https://github.com/beer-garden/beer-garden.io/commits/master//docs/app/mongo_pruner.adoc">History</a></div></div></div><div class="col-lg-12 navigation"><div id="toc" class="toc"><div class="title" id="toctitle">Table of Contents</div></div></div></div><div class="col-lg-8" id="docContent"><div class="paragraph">
<p>One of the optional features Beer Garden comes with is a Mongo Pruner. You can use it to automatically age off certain requests from the database. This can be useful to prevent your database from growing uncontrolled.</p>
</div>
<div class="paragraph">
<p>First, you need to be aware that Beer Garden makes a distinction between two types of commands - "Action" and "Info". Beer Garden doesn&#8217;t enforce any rules about which type of commands are info and which are actions. Some best practice guidlines to follow are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If executing the command changes the state of something it should be an "Action" (this is the default).</p>
</li>
<li>
<p>If the command&#8217;s only job is to return data, and does not have side effects, it should be an "Info".</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>When you create a command, you can mark it as "Info" like this:</p>
</div>
<div class="listingblock">
<div class="title">info_command.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="decorator">@command</span>(command_type=<span class="string"><span class="delimiter">&quot;</span><span class="content">INFO</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">def</span> <span class="function">time</span>(<span class="predefined-constant">self</span>):
    <span class="keyword">return</span> <span class="predefined">str</span>(datetime.utcnow())</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point you might ask, why bother making this distinction if Beer Garden isn&#8217;t going to enforce anything? Well, we&#8217;ve found that Beer Garden administrators generally care very much about preserving the history for Requests that change things (aka Action requests) and care very little about preserving history of Requests that don&#8217;t (aka Info requests).</p>
</div>
<div class="paragraph">
<p>Ok, that&#8217;s enough background. Onto the Mongo Pruner:
The pruner will periodically check the database and age off requests according to the Time-to-Live defined in the Bartender configuration. If you look at the config file you&#8217;ll see that the TTLs are broken out by command type:</p>
</div>
<div class="listingblock">
<div class="title">bartender-config.yaml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">db</span>:
  <span class="key">ttl</span>:
    <span class="key">action</span>: <span class="string"><span class="content">-1</span></span>
    <span class="key">event</span>: <span class="string"><span class="content">15</span></span>
    <span class="key">info</span>: <span class="string"><span class="content">15</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This tells the pruner how long to keep Requests around after they complete. A negative value means never remove that type of request, so it&#8217;ll stick around forever.</p>
</div>
<div class="paragraph">
<p>You can see there&#8217;s an extra TTL for <code>event</code> as well. This refers to Beer Garden Events that have been written to the database - these can be aged off just like Requests.</p>
</div>
<div class="paragraph">
<p>The Mongo Pruner will run with a frequency of half the smallest non-negative TTL specified in the config. So in the example above, the Pruner will run every 7.5 minutes.</p>
</div>
<div class="paragraph">
<p>Finally, a quick note on how the Pruner handles child requests: it doesn&#8217;t. The pruner only looks at top-level (parent) requests when determining what to remove. However, when a top-level request is removed all its children are removed with it. So in the example above a top-level Info Request will be pruned 15 minutes after it completes, but if an Action Request generates an Info Request as part of its processing both Requests will persist forever.</p>
</div></div><hr></div></div></main></div><footer id="bgfooter"><div class="container"><div class="row"><div class="col-sm-3"><h5>Get Started</h5><ul><li><a href="/">Home</a></li><li><a href="https://github.com/beer-garden/beer-garden/blob/master/CONTRIBUTING.md">Contribute</a></li></ul></div><div class="col-sm-3"><h5>About us</h5><ul><li><a href="https://github.com/beer-garden/beer-garden/blob/master/AUTHORS.md">Contributors</a></li><li><a href="/news">News</a></li></ul></div><div class="col-sm-3"><h5>Support</h5><ul><li><a href="https://github.com/beer-garden/beer-garden/issues">GitHub</a></li></ul></div><div class="col-sm-3 info"><h5>Information</h5><p>Composed in AsciiDoc. Styled by bootstrap. Baked with Awestruct.</p></div></div></div><div class="social-networks"><a class="github" href="https://github.com/beer-garden/beer-garden"><i class="fa fa-github"></i></a></div><div class="footer-copyright"><p>Â© Beer Garden Project 2022.</p></div></footer></body><script>$('.toggle-navigation').click(function() { $('.navigation').toggle(); $('#docContent').toggleClass('col-lg-8'); $('#docContent').toggleClass('col-lg-12'); $('#docContent').toggleClass('top-buffer'); $('.toggle-target').toggleClass('off'); });</script>